generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Enums ---

// --- Enums ---

enum OrganizationRole {
  ADMIN
  TREASURER
  COMMITTEE_MEMBER
  VOLUNTEER
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DonationCategory {
  GENERAL
  BHOG
  DECORATION
  LIGHTING
  OTHER
}

enum ExpenseCategory {
  IDOL
  DECORATION
  LIGHTING
  FOOD
  SOUND
  SECURITY
  MISCELLANEOUS
}

enum BhogStatus {
  PENDING
  PREPARED
}

enum VolunteerStatus {
  PENDING
  ACTIVE
  INACTIVE
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum OrganizationType {
  FESTIVAL
  CLUB
}

enum EventStatus {
  PLANNED
  ACTIVE
  COMPLETED
  ARCHIVED
}

// --- Models ---

model User {
  id            String               @id @default(cuid())
  email         String              @unique
  phone         String?             @unique
  name          String?
  image         String?
  password      String?             // Hashed password for Credentials auth
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  memberships   OrganizationMember[]
}

model Organization {
  id            String           @id @default(cuid())
  name          String
  slug          String           @unique
  description   String?
  startDate     DateTime
  endDate       DateTime
  budgetTarget  Decimal?         @db.Decimal(12, 2)
  type          OrganizationType @default(FESTIVAL)
  featureFlags  Json?            // For modularity
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  members     OrganizationMember[]
  donations   Donation[]
  expenses    Expense[]
  bhogItems   BhogItem[]
  volunteers  Volunteer[]
  events      Event[]
  tasks       VolunteerTask[]
  invitations OrganizationInvitation[]

  @@index([slug])
}

model OrganizationMember {
  id             String           @id @default(cuid())
  userId         String?          
  email          String           
  organizationId String
  role           OrganizationRole
  isArchived     Boolean          @default(false)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  user           User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Audit relations
  donationsAdded   Donation[]
  expensesAdded    Expense[]      @relation("ExpenseAddedBy")
  expensesApproved Expense[]      @relation("ExpenseApprovedBy")
  assignedTasks    VolunteerTask[]
  eventAssignments EventAssignment[]
  invitationsSent  OrganizationInvitation[]

  @@unique([userId, organizationId])
  @@unique([email, organizationId])
  @@index([userId])
  @@index([organizationId])
}


model Donation {
  id             String           @id @default(cuid())
  donorName      String
  amount         Decimal          @db.Decimal(12, 2)
  category       DonationCategory @default(GENERAL)
  date           DateTime         @default(now())
  notes          String?
  isArchived     Boolean          @default(false)
  
  addedById      String?
  addedBy        OrganizationMember? @relation(fields: [addedById], references: [id], onDelete: SetNull)
  
  organizationId String
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([organizationId])
  @@index([addedById])
}

model Expense {
  id             String           @id @default(cuid())
  title          String
  amount         Decimal          @db.Decimal(12, 2)
  category       ExpenseCategory  @default(MISCELLANEOUS)
  status         ExpenseStatus    @default(PENDING)
  notes          String?
  isArchived     Boolean          @default(false)
  
  addedById      String
  addedBy        OrganizationMember @relation("ExpenseAddedBy", fields: [addedById], references: [id], onDelete: Restrict)
  
  approvedById   String?
  approvedBy     OrganizationMember? @relation("ExpenseApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  
  organizationId String
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  eventId        String?
  event          Event?            @relation(fields: [eventId], references: [id], onDelete: SetNull)

  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@index([organizationId])
  @@index([eventId])
  @@index([status])
}

model BhogItem {
  id             String     @id @default(cuid())
  name           String
  quantity       String
  status         BhogStatus @default(PENDING)
  sponsorName    String?
  storage        String?    
  estimatedCost  Decimal?   @db.Decimal(12, 2)
  notes          String?
  isArchived     Boolean    @default(false)
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@index([organizationId])
}

model Volunteer {
  id             String          @id @default(cuid())
  name           String
  phone          String?
  email          String?
  status         VolunteerStatus @default(PENDING)
  assignedTask   String?
  isArchived     Boolean         @default(false)
  
  organizationId String
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@index([organizationId])
}

model Event {
  id              String   @id @default(cuid())
  organizationId  String
  title           String
  description     String?
  startTime       DateTime
  endTime         DateTime
  location        String?

  budgetTarget    Decimal? @db.Decimal(12, 2)  
  status          EventStatus @default(PLANNED)
  isArchived      Boolean  @default(false)

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  expenses        Expense[]
  tasks           VolunteerTask[]
  assignments     EventAssignment[]
  registrations   EventRegistration[]
  invitations     OrganizationInvitation[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
}

model VolunteerTask {
  id              String   @id @default(cuid())
  organizationId  String
  eventId         String?
  title           String
  description     String?
  assignedToId    String
  status          TaskStatus @default(PENDING)
  priority        TaskPriority @default(MEDIUM)
  dueDate         DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization    Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  event           Event?         @relation(fields: [eventId], references: [id], onDelete: SetNull)
  assignedTo      OrganizationMember @relation(fields: [assignedToId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([eventId])
  @@index([assignedToId])
}

model EventAssignment {
  id                     String @id @default(cuid())
  eventId                String
  organizationMemberId   String

  event                  Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  member                 OrganizationMember @relation(fields: [organizationMemberId], references: [id], onDelete: Cascade)

  createdAt              DateTime @default(now())

  @@unique([eventId, organizationMemberId])
  @@index([eventId])
  @@index([organizationMemberId])
}

model EventRegistration {
  id              String   @id @default(cuid())
  eventId         String
  name            String
  email           String
  phone           String?
  notes           String?
  attended        Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  event           Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

model OrganizationInvitation {
  id              String   @id @default(cuid())
  organizationId  String
  email           String
  role            OrganizationRole
  token           String   @unique
  expiresAt       DateTime
  accepted        Boolean  @default(false)
  eventId         String?
  event           Event?       @relation(fields: [eventId], references: [id], onDelete: SetNull)
  invitedById     String?

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy       OrganizationMember? @relation(fields: [invitedById], references: [id], onDelete: SetNull)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@index([email])
}
